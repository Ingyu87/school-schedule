<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen py-8">
    <div class="max-w-6xl w-full mx-auto px-4">
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <!-- í—¤ë” -->
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-2">
                        <i class="fa-solid fa-shield-halved text-purple-600 mr-2"></i>ê´€ë¦¬ì í˜ì´ì§€
                    </h1>
                    <p class="text-gray-600">ë“±ë¡ëœ í•™êµ ê´€ë¦¬</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="window.location.href='school-select.html'" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <i class="fa-solid fa-school mr-2"></i>í•™êµ ì„ íƒ
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>ë¡œê·¸ì•„ì›ƒ
                    </button>
                </div>
            </div>
            
            <!-- ê²€ìƒ‰ ë° ìƒˆë¡œê³ ì¹¨ -->
            <div class="mb-6 flex gap-3">
                <input 
                    type="text" 
                    id="school-search"
                    class="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none transition"
                    placeholder="ğŸ” í•™êµëª…ìœ¼ë¡œ ê²€ìƒ‰..."
                    oninput="filterSchools()"
                >
                <button onclick="loadSchools()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-bold">
                    <i class="fa-solid fa-rotate mr-2"></i>ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            
            <!-- í•™êµ ëª©ë¡ -->
            <div class="overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-purple-100">
                            <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">í•™êµëª…</th>
                            <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">ë“±ë¡ì¼</th>
                            <th class="border border-gray-300 px-4 py-3 text-left font-bold text-gray-900">ë¹„ë°€ë²ˆí˜¸ í•´ì‹œ</th>
                            <th class="border border-gray-300 px-4 py-3 text-center font-bold text-gray-900">ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="school-list">
                        <tr>
                            <td colspan="4" class="border border-gray-300 px-4 py-8 text-center text-gray-500">
                                <i class="fa-solid fa-spinner fa-spin mr-2"></i>ë¡œë”© ì¤‘...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- í†µê³„ -->
            <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="text-sm text-blue-600 font-bold mb-1">ì´ ë“±ë¡ í•™êµ</div>
                    <div class="text-2xl font-bold text-blue-900" id="total-schools">0</div>
                </div>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div class="text-sm text-green-600 font-bold mb-1">ì´ë²ˆ ë‹¬ ë“±ë¡</div>
                    <div class="text-2xl font-bold text-green-900" id="month-schools">0</div>
                </div>
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                    <div class="text-sm text-purple-600 font-bold mb-1">ì˜¤ëŠ˜ ë“±ë¡</div>
                    <div class="text-2xl font-bold text-purple-900" id="today-schools">0</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ëª¨ë‹¬ -->
    <div id="reset-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-900 mb-4">
                <i class="fa-solid fa-key text-purple-600 mr-2"></i>ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
            </h3>
            <p class="text-gray-700 mb-4">
                <span id="reset-school-name" class="font-bold"></span>ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
            </p>
            <p class="text-sm text-gray-500 mb-4">
                ì´ˆê¸°í™” í›„ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                <input 
                    type="password" 
                    id="admin-password"
                    class="w-full px-4 py-2 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 outline-none"
                    placeholder="ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ì…ë ¥"
                >
            </div>
            <div class="flex gap-3 justify-end">
                <button onclick="closeResetModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    ì·¨ì†Œ
                </button>
                <button onclick="confirmResetPassword()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-bold">
                    ì´ˆê¸°í™”
                </button>
            </div>
        </div>
    </div>
    
    <!-- Firebase ì´ˆê¸°í™” -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyATebSC3BCAlTVUO_ybyg1OoIdqgBlxFBc",
            authDomain: "school-schedule-d16bc.firebaseapp.com",
            projectId: "school-schedule-d16bc",
            storageBucket: "school-schedule-d16bc.firebasestorage.app",
            messagingSenderId: "173998479308",
            appId: "1:173998479308:web:b1ea6a69c743d838a5ef69",
            measurementId: "G-NPPXKJCGGB"
        };
        
        const firebaseApp = initializeApp(firebaseConfig);
        window.firebaseAuth = getAuth(firebaseApp);
        window.firebaseDb = getFirestore(firebaseApp);
        
        // ìµëª… ì¸ì¦ (Firebase ê¶Œí•œì„ ìœ„í•´ í•„ìš”)
        try {
            await signInAnonymously(window.firebaseAuth);
            console.log('Firebase anonymous auth successful');
        } catch (error) {
            console.error('Firebase anonymous auth error:', error);
        }
        
        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
        const saved = localStorage.getItem('current_school');
        if (!saved || JSON.parse(saved).name !== 'MASTER') {
            // ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            const adminPassword = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (adminPassword !== '0307') {
                alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                window.location.href = 'login.html';
            } else {
                // ê´€ë¦¬ì ëª¨ë“œë¡œ ì„¤ì •
                localStorage.setItem('current_school', JSON.stringify({ name: 'MASTER', isMaster: true }));
            }
        }
        
        // í•™êµ ëª©ë¡ ë¡œë“œ
        loadSchools();
    </script>
    
    <script>
        let currentResetSchool = null;
        
        async function loadSchools() {
            try {
                const { collection, getDocs } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const schoolsRef = collection(window.firebaseDb, 'schools');
                const snapshot = await getDocs(schoolsRef);
                
                const schools = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    schools.push({
                        id: doc.id,
                        name: data.name || doc.id,
                        passwordHash: data.passwordHash || '',
                        createdAt: data.createdAt || ''
                    });
                });
                
                // ì´ë¦„ìˆœ ì •ë ¬
                schools.sort((a, b) => a.name.localeCompare(b.name));
                
                renderSchools(schools);
                updateStats(schools);
            } catch (error) {
                console.error('Load schools error:', error);
                document.getElementById('school-list').innerHTML = 
                    '<tr><td colspan="4" class="border border-gray-300 px-4 py-8 text-center text-red-500">í•™êµ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }
        
        function renderSchools(schools) {
            const tbody = document.getElementById('school-list');
            
            if (schools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="border border-gray-300 px-4 py-8 text-center text-gray-500">ë“±ë¡ëœ í•™êµê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            
            tbody.innerHTML = schools.map(school => {
                const createdDate = school.createdAt ? new Date(school.createdAt).toLocaleString('ko-KR') : '-';
                const hashDisplay = school.passwordHash ? 
                    `<span class="font-mono text-xs">${school.passwordHash.substring(0, 16)}...</span>` : 
                    '<span class="text-gray-400">ì—†ìŒ</span>';
                
                return `
                    <tr class="school-row hover:bg-gray-50">
                        <td class="border border-gray-300 px-4 py-3 font-bold text-gray-900">${school.name}</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-700">${createdDate}</td>
                        <td class="border border-gray-300 px-4 py-3 text-gray-600">${hashDisplay}</td>
                        <td class="border border-gray-300 px-4 py-3 text-center">
                            <button 
                                onclick="openResetModal('${school.id}', '${school.name.replace(/'/g, "\\'")}')" 
                                class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition text-sm font-bold"
                            >
                                <i class="fa-solid fa-key mr-1"></i>ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats(schools) {
            const total = schools.length;
            const now = new Date();
            const thisMonth = schools.filter(s => {
                if (!s.createdAt) return false;
                const created = new Date(s.createdAt);
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;
            const today = schools.filter(s => {
                if (!s.createdAt) return false;
                const created = new Date(s.createdAt);
                return created.toDateString() === now.toDateString();
            }).length;
            
            document.getElementById('total-schools').textContent = total;
            document.getElementById('month-schools').textContent = thisMonth;
            document.getElementById('today-schools').textContent = today;
        }
        
        window.filterSchools = function() {
            const searchTerm = document.getElementById('school-search').value.toLowerCase();
            const rows = document.querySelectorAll('.school-row');
            
            rows.forEach(row => {
                const schoolName = row.querySelector('td:first-child').textContent.toLowerCase();
                if (schoolName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        };
        
        window.openResetModal = function(schoolId, schoolName) {
            currentResetSchool = { id: schoolId, name: schoolName };
            document.getElementById('reset-school-name').textContent = schoolName;
            document.getElementById('admin-password').value = '';
            document.getElementById('reset-modal').classList.remove('hidden');
        };
        
        window.closeResetModal = function() {
            document.getElementById('reset-modal').classList.add('hidden');
            currentResetSchool = null;
        };
        
        window.confirmResetPassword = async function() {
            const adminPassword = document.getElementById('admin-password').value;
            
            if (adminPassword !== '0307') {
                alert('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!currentResetSchool) return;
            
            // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            const newPassword = prompt(`${currentResetSchool.name}ì˜ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if (!newPassword) {
                return;
            }
            
            if (newPassword.length < 4) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            
            try {
                // ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
                const encoder = new TextEncoder();
                const data = encoder.encode(newPassword);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const passwordHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                
                // Firebase ì—…ë°ì´íŠ¸
                const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
                const schoolRef = doc(window.firebaseDb, 'schools', currentResetSchool.id);
                
                await setDoc(schoolRef, {
                    passwordHash: passwordHash,
                    passwordResetAt: new Date().toISOString()
                }, { merge: true });
                
                alert(`âœ… ${currentResetSchool.name}ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nìƒˆ ë¹„ë°€ë²ˆí˜¸: ${newPassword}`);
                closeResetModal();
                loadSchools();
                
            } catch (error) {
                console.error('Reset password error:', error);
                alert('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        };
        
        window.logout = function() {
            if (confirm('ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('current_school');
                window.location.href = 'login.html';
            }
        };
        
        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeResetModal();
            }
        });
    </script>
</body>
</html>

